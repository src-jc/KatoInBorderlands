<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Run Way</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            height: 100vh;
            margin: 0;
        }
        #game {
            display: grid;
            grid-template-columns: repeat(25, 24px);
            grid-template-rows: repeat(25, 24px);
            gap: 1px;
        }
    </style>
</head>
<body>
<div id="game"></div>

<script>
    const size = 25;
    const game = document.getElementById("game");
    let grid = [];
    let player, monster, exit;
    let turnCounter = 0;

    function initGame() {
        player = {x:1, y:1};
        monster = {x:size-3, y:size-3};
        exit = {x:size-2, y:size-2};
        generateMaze();
        render();
    }

    function generateMaze() {
        grid = Array.from({length: size}, ()=> Array(size).fill(1));
        function carve(x, y) {
            const dirs = [[0,-2],[0,2],[-2,0],[2,0]].sort(()=>Math.random()-0.5);
            for (let [dx, dy] of dirs) {
                let nx = x+dx, ny = y+dy;
                if (nx>0 && ny>0 && nx<size-1 && ny<size-1 && grid[ny][nx]===1) {
                    grid[ny][nx] = 0;
                    grid[y+dy/2][x+dx/2] = 0;
                    carve(nx, ny);
                }
            }
        }
        grid[1][1] = 0;
        carve(1,1);
        grid[exit.y][exit.x] = 0;
    }

    function render() {
        game.innerHTML = "";
        for (let y=0; y<size; y++) {
            for (let x=0; x<size; x++) {
                let cell = document.createElement("div");
                cell.classList.add("cell");
                if (grid[y][x]===1) cell.classList.add("wall");
                if (x===player.x && y===player.y) cell.classList.add("player");
                if (x===monster.x && y===monster.y) cell.classList.add("monster");
                if (x===exit.x && y===exit.y) cell.classList.add("exit");
                game.appendChild(cell);
            }
        }
    }

    function movePlayer(dx, dy) {
        let nx = player.x+dx, ny = player.y+dy;
        if (grid[ny][nx]===0) {
            player.x = nx; player.y = ny;
            turnCounter++;
            moveMonster();
            if (turnCounter % 10 === 0) plotTwist(); // every 5 turns
            render();
            checkGame();
        }
    }

    function bfs(start, goal) {
        let queue = [[start.x, start.y]];
        let visited = Array.from({length: size}, ()=> Array(size).fill(false));
        let parent = {};
        visited[start.y][start.x] = true;

        while (queue.length) {
            let [x,y] = queue.shift();
            if (x===goal.x && y===goal.y) break;
            for (let [dx,dy] of [[1,0],[-1,0],[0,1],[0,-1]]) {
                let nx=x+dx, ny=y+dy;
                if (nx>=0 && ny>=0 && nx<size && ny<size && !visited[ny][nx] && grid[ny][nx]===0) {
                    visited[ny][nx] = true;
                    parent[ny+","+nx] = [x,y];
                    queue.push([nx,ny]);
                }
            }
        }

        let path = [];
        let cur = [goal.x, goal.y];
        while (parent[cur[1]+","+cur[0]]) {
            path.push(cur);
            cur = parent[cur[1]+","+cur[0]];
        }
        path.reverse();
        return path;
    }

    function moveMonster() {
        let path = bfs(monster, player);
        if (path.length > 0) {
            let [nx, ny] = path[0];
            monster.x = nx;
            monster.y = ny;
        }
    }

    function plotTwist() {
        // Close a random open path
        let openCells = [];
        for (let y=1; y<size-1; y++) {
            for (let x=1; x<size-1; x++) {
                if (grid[y][x]===0 && !(x===player.x && y===player.y) && !(x===exit.x && y===exit.y)) {
                    openCells.push([x,y]);
                }
            }
        }
        if (openCells.length > 0) {
            let [cx,cy] = openCells[Math.floor(Math.random()*openCells.length)];
            grid[cy][cx] = 1;
        }

        // Open a random wall
        let wallCells = [];
        for (let y=1; y<size-1; y++) {
            for (let x=1; x<size-1; x++) {
                if (grid[y][x]===1) wallCells.push([x,y]);
            }
        }
        if (wallCells.length > 0) {
            let [wx,wy] = wallCells[Math.floor(Math.random()*wallCells.length)];
            grid[wy][wx] = 0;
        }
    }

    function checkGame() {
        if (player.x===monster.x && player.y===monster.y) {
            alert("Game Over! The monster caught you!");
            initGame();
        } else if (player.x===exit.x && player.y===exit.y) {
            alert("You Win! You escaped!");
            initGame();
        }
    }

    document.addEventListener("keydown", e=>{
        if (e.key==="ArrowUp") movePlayer(0,-1);
        if (e.key==="ArrowDown") movePlayer(0,1);
        if (e.key==="ArrowLeft") movePlayer(-1,0);
        if (e.key==="ArrowRight") movePlayer(1,0);
    });

    initGame();
</script>
</body>
</html>
